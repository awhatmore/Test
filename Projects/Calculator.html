<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart SI Unit Calculator | Whatmore Industries</title>
  <style>
    body { background: #111; color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 2rem; }
    h2 { text-align: center; }
    #pretty-input-output {
      font-size: 1.5em; min-height: 2em; color:#fff; margin-bottom:0.4em;
      display: inline-block; /* So we can measure width */
    }
    #steps-math-output { margin-bottom: 0.7em; }
    .steps-eq-row {
      display: flex;
      align-items: baseline;
      min-height: 2em;
      margin-bottom: 0.8em;  /* Adjust as desired */
    }
    .steps-indent {
      display: inline-block;
      visibility: hidden;
      white-space: pre;
      font-size: 1.5em;
      font-family: inherit;
      padding-right: 0.3em;
    }
    .eq-label { font-size: 1.5em; margin-right: 0.2em; color: #fff;}
    .steps-eq-latex { font-size: 1.2em; color: #fff;}
    #input-box {
      width: 100%;
      font-size: 1.25rem;
      padding: 0.5rem 1rem;
      background: #181818;
      color: #0f0;
      border: 1px solid #444;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      box-sizing: border-box;
    }
    #result-panel {
      background: #222;
      padding: 1rem;
      border-radius: 0.9rem;
      font-size: 1rem;
      margin-top: 1rem;
      min-height: 60px;
    }
    .section-label { font-weight: bold; color: #0ff; margin-top: 0.5em; }
    .calculator {
      display: grid;
      grid-template-columns: repeat(3, 60px);
      gap: 5px;
    }
    button {
      width: 60px;
      height: 60px;
      font-size: 1.2em;
    }
    .wide { grid-column: span 2; }
    .output-row { margin-bottom: 0.3em; }
    .unit-breakdown { color: #6cf; font-family: 'Consolas', monospace; }
    .sigfig-active { background: #0ff; color: #111; }
  </style>
  <!-- MATHJAX CDN FOR BEAUTIFUL OUTPUT -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <h2>Smart SI Unit Calculator</h2>
  <div style="display: flex; align-items: flex-start;">
    <div id="pretty-input-output"></div>
    <div id="steps-math-output" style="flex:1;"></div>
  </div>
  <div style="display:flex;align-items:center;margin-bottom:0.7em;">
    <button id="copy-latex-btn" style="margin-left:8px;padding:4px 8px;font-size:1em;cursor:pointer;">ðŸ“‹</button>
  </div>
  <input id="input-box"
    placeholder="Enter calculation (e.g. 5 / 9xxx)"
    autocomplete="off"
    oninput="updatePrettyInput(); calculate();"
    onkeydown="if(event.key==='Enter'){calculate(); return false;}">

  <div style="margin-bottom:0.5em;">
    Significant figures: 
    <button class="sigfig-btn" onclick="setSigFigs(3)">3</button>
    <button class="sigfig-btn" onclick="setSigFigs(6)">6</button>
    <button class="sigfig-btn" onclick="setSigFigs(10)">10</button>
  </div>
  <div style="margin-bottom: 1em;">
  <label for="unit-system">Unit System:</label>
  <select id="unit-system" onchange="updateUnitOptions()">
    <option value="metric">Metric (SI)</option>
    <option value="imperial">Imperial (US)</option>
  </select>
  
  <label for="discipline" style="margin-left: 1em;">Discipline:</label>
  <select id="discipline" onchange="updateUnitOptions()">
    <option value="electrical">Electrical</option>
    <option value="mechanical">Mechanical</option>
    <!-- <option value="general">General</option> -->
  </select>
</div>
  <div id="unit-buttons-area" style="margin-bottom: 1.2em;"></div>
  <div class="calculator">
    <button onclick="appendCalc('1')">1</button>
    <button onclick="appendCalc('2')">2</button>
    <button onclick="appendCalc('3')">3</button>
    <button onclick="appendCalc('4')">4</button>
    <button onclick="appendCalc('5')">5</button>
    <button onclick="appendCalc('6')">6</button>
    <button onclick="appendCalc('7')">7</button>
    <button onclick="appendCalc('8')">8</button>
    <button onclick="appendCalc('9')">9</button>
    <button onclick="appendCalc('.')">.</button>
    <button onclick="appendCalc('0')">0</button>
    <button onclick="calculate()">=</button>
    <button class="wide" onclick="backspace()">Backspace</button>
    <button class="wide" onclick="clearCalc()">Clear</button>
  </div>
  <div class="calculator" style="margin-bottom: 8px;">
    <button onclick="appendCalc('x')">x</button>
    <button onclick="appendCalc('y')">y</button>
    <button onclick="appendCalc('z')">z</button>
    <button onclick="appendCalc('a')">a</button>
    <button onclick="appendCalc('b')">b</button>
    <button onclick="appendCalc('c')">c</button>
    <button onclick="appendCalc('^')">^</button>
  </div>
  <div style="margin:1rem 0;">
    <button onclick="appendCalc(' + ')">+</button>
    <button onclick="appendCalc(' - ')">-</button>
    <button onclick="appendCalc(' * ')">*</button>
    <button onclick="appendCalc(' / ')">/</button>
  </div>
  <!-- Example unit buttons, add your own as needed -->
  <!--<div>
    <strong>Length</strong><br>
    <button onclick="appendCalc(' nm ')">nm</button>
    <button onclick="appendCalc(' Î¼m ')">Î¼m</button>
    <button onclick="appendCalc(' mm ')">mm</button>
    <button onclick="appendCalc(' cm ')">cm</button>
    <button onclick="appendCalc(' m ')">m</button>
    <button onclick="appendCalc(' km ')">km</button>
    <button onclick="appendCalc(' in ')">in</button>
    <button onclick="appendCalc(' ft ')">ft</button>
    <button onclick="appendCalc(' yd ')">yd</button>
    <button onclick="appendCalc(' mi ')">mi</button>
  </div>
  <div>
    <strong>Mass</strong><br>
    <button onclick="appendCalc(' mg ')">mg</button>
    <button onclick="appendCalc(' g ')">g</button>
    <button onclick="appendCalc(' kg ')">kg</button>
    <button onclick="appendCalc(' t ')">t</button>
    <button onclick="appendCalc(' oz ')">oz</button>
    <button onclick="appendCalc(' lb ')">lb</button>
    <button onclick="appendCalc(' st ')">st</button>
  </div>
  <div>
    <strong>Time</strong><br>
    <button onclick="appendCalc(' ns ')">ns</button>
    <button onclick="appendCalc(' Î¼s ')">Î¼s</button>
    <button onclick="appendCalc(' ms ')">ms</button>
    <button onclick="appendCalc(' s ')">s</button>
    <button onclick="appendCalc(' min ')">min</button>
    <button onclick="appendCalc(' hr ')">hr</button>
    <button onclick="appendCalc(' day ')">day</button>
  </div>
  <div>
    <strong>Electricity</strong><br>
    <button onclick="appendCalc(' A ')">A</button>
    <button onclick="appendCalc(' V ')">V</button>
    <button onclick="appendCalc(' W ')">W</button>
    <button onclick="appendCalc(' F ')">F</button>
    <button onclick="appendCalc(' Î© ')">Î©</button>
    <button onclick="appendCalc(' C ')">C</button>
  </div>-->
  <div id="result-panel"></div>

<script>
  
  function formatSigFig(num, sigfigs) {
  if (isNaN(num)) return '?';
  if (num === 0) return '0';
  // Use toPrecision, but strip possible trailing zeros (for pretty output)
  let s = Number(num).toPrecision(sigfigs);
  // If the result is in scientific notation, leave as is
  if (s.includes('e')) return s;
  // Remove trailing zeros and dot if not needed
  s = s.replace(/\.?0+$/, '');
  return s;
}

const BASES = ['kg', 'm', 's', 'A', 'K', 'mol', 'cd'];
const UNIT_TABLE = {
  m:   {kg:0, m:1, s:0, A:0, K:0, mol:0, cd:0},
  kg:  {kg:1, m:0, s:0, A:0, K:0, mol:0, cd:0},
  s:   {kg:0, m:0, s:1, A:0, K:0, mol:0, cd:0},
  A:   {kg:0, m:0, s:0, A:1, K:0, mol:0, cd:0},
  K:   {kg:0, m:0, s:0, A:0, K:1, mol:0, cd:0},
  mol: {kg:0, m:0, s:0, A:0, K:0, mol:1, cd:0},
  cd:  {kg:0, m:0, s:0, A:0, K:0, mol:0, cd:1},
  N:   {kg:1, m:1, s:-2, A:0, K:0, mol:0, cd:0},
  J:   {kg:1, m:2, s:-2, A:0, K:0, mol:0, cd:0},
  W:   {kg:1, m:2, s:-3, A:0, K:0, mol:0, cd:0},
  V:   {kg:1, m:2, s:-3, A:-1, K:0, mol:0, cd:0},
  C:   {kg:0, m:0, s:1, A:1, K:0, mol:0, cd:0},
  Î©:   {kg:1, m:2, s:-3, A:-2, K:0, mol:0, cd:0},
  F:   {kg:-1, m:-2, s:4, A:2, K:0, mol:0, cd:0},
  S:   {kg:-1, m:-2, s:3, A:2, K:0, mol:0, cd:0},
  H:   {kg:1, m:2, s:-2, A:-2, K:0, mol:0, cd:0},
  VA:  {kg:1, m:2, s:-3, A:0, K:0, mol:0, cd:0},
};
const DERIVED_LOOKUP = Object.fromEntries(
  Object.entries(UNIT_TABLE).map(([k,v])=>[JSON.stringify(v),k])
);
const UNITS = {
  nm:  [1e-9, 'm'], Î¼m:[1e-6,'m'], mm:[1e-3,'m'], cm:[1e-2,'m'], m:[1,'m'], km:[1e3,'m'],
  in: [0.0254,'m'], ft:[0.3048,'m'], yd:[0.9144,'m'], mi:[1609.34,'m'],
  mg:[1e-6,'kg'], g:[1e-3,'kg'], kg:[1,'kg'], t:[1000,'kg'],
  oz:[0.0283495,'kg'], lb:[0.453592,'kg'], st:[6.35029,'kg'],
  ns:[1e-9,'s'], Î¼s:[1e-6,'s'], ms:[1e-3,'s'], s:[1,'s'], min:[60,'s'], hr:[3600,'s'], day:[86400,'s'],
  A:[1,'A'], V:[1,'V'], W:[1,'W'], F:[1,'F'], Î©:[1,'Î©'], C:[1,'C'],
  N:[1,'N'], J:[1,'J'], S:[1,'S'], H:[1,'H'],
  VA:[1,'VA'],
};

  const UNIT_CATEGORIES = {
  electrical: {
    metric: [
      {label: 'V', unit: 'V'}, {label: 'A', unit: 'A'}, {label: 'Î©', unit: 'Î©'},
      {label: 'W', unit: 'W'}, {label: 'F', unit: 'F'}, {label: 'S', unit: 'S'},
      {label: 'H', unit: 'H'}, {label: 's', unit: 's'} // <--- seconds added!
    ],
    imperial: [
      // Imperial electrical units (rare, but you can add as needed)
      {label: 'V', unit: 'V'}, {label: 'A', unit: 'A'}, {label: 'Î©', unit: 'Î©'},
      {label: 'W', unit: 'W'}, {label: 'F', unit: 'F'}, {label: 'S', unit: 'S'},
      {label: 'H', unit: 'H'}, {label: 's', unit: 's'}
    ],
    length: [
      {label: 'm', unit: 'm'}, {label: 'cm', unit: 'cm'}, {label: 'mm', unit: 'mm'},
      {label: 'ft', unit: 'ft'}, {label: 'in', unit: 'in'}
    ]
  },
  mechanical: {
    metric: [
      {label: 'N', unit: 'N'}, {label: 'kg', unit: 'kg'}, {label: 'Pa', unit: 'Pa'},
      {label: 'J', unit: 'J'}, {label: 'W', unit: 'W'}, {label: 'm', unit: 'm'},
      {label: 'cm', unit: 'cm'}, {label: 'mm', unit: 'mm'}, {label: 's', unit: 's'}
    ],
    imperial: [
      {label: 'lb', unit: 'lb'}, {label: 'psi', unit: 'psi'}, {label: 'ft', unit: 'ft'},
      {label: 'in', unit: 'in'}, {label: 'lbf', unit: 'lbf'}, {label: 'ft-lb', unit: 'ft-lb'}, {label: 's', unit: 's'}
    ]
  }
};


let currentSigFigs = 3;

function updatePrettyInput() {
  let input = document.getElementById('input-box').value;
  let prettyDiv = document.getElementById('pretty-input-output');
  if (!input.trim()) {
    prettyDiv.innerHTML = '';
    MathJax.typesetPromise();
    return;
  }
  prettyDiv.innerHTML = `\\(${formatInputAsLatex(input)}\\)`;
  MathJax.typesetPromise();
}
function updateUnitOptions() {
  const discipline = document.getElementById('discipline').value;
  const system = document.getElementById('unit-system').value;
  const area = document.getElementById('unit-buttons-area');
  area.innerHTML = "";

  let html = '';

  // Render main group buttons (metric or imperial only)
  (UNIT_CATEGORIES[discipline][system] || []).forEach(unit => {
    html += `<button class="unit-btn ${system}" style="display:inline-block;" onclick="appendCalc(' ${unit.unit} ')">${unit.label}</button>`;
  });

  // If electrical, show Length as secondary group (all units, but show/hide per system)
  if (discipline === "electrical") {
    html += ' <span style="opacity:0.5;margin-left:1em;">Length:</span> ';
    UNIT_CATEGORIES.electrical.length.forEach(unit => {
      // Show metric length if metric, imperial if imperial, show both if you want
      let show = (system === 'metric' && ['m','cm','mm'].includes(unit.unit)) ||
                 (system === 'imperial' && ['ft','in'].includes(unit.unit));
      html += `<button class="unit-btn length-btn" style="display:${show?'inline-block':'none'};" onclick="appendCalc(' ${unit.unit} ')">${unit.label}</button>`;
    });
  }

  area.innerHTML = html;
}


function setSigFigs(n) {
  currentSigFigs = n;
  document.querySelectorAll('.sigfig-btn').forEach(btn => {
    btn.classList.toggle('sigfig-active', btn.textContent == n);
  });
  calculate();
}

function appendCalc(val) {
  const box = document.getElementById('input-box');
  if (!box) return;
  const start = box.selectionStart;
  const end = box.selectionEnd;
  const text = box.value;
  box.value = text.slice(0, start) + val + text.slice(end);
  const caretPos = start + val.length;
  box.setSelectionRange(caretPos, caretPos);
  box.focus();
  updatePrettyInput();
  calculate();
}

function clearCalc() {
  document.getElementById('input-box').value = '';
  document.getElementById('result-panel').innerHTML = '';
  document.getElementById('pretty-input-output').innerHTML = '';
  document.getElementById('steps-math-output').innerHTML = '';
  calculate();
}

function backspace() {
  const box = document.getElementById('input-box');
  const start = box.selectionStart;
  const end = box.selectionEnd;
  if (start === end && start > 0) {
    box.value = box.value.slice(0, start-1) + box.value.slice(end);
    box.setSelectionRange(start-1, start-1);
  } else {
    box.value = box.value.slice(0, start) + box.value.slice(end);
    box.setSelectionRange(start, start);
  }
  box.focus();
  updatePrettyInput();
  calculate();
}

function formatInputAsLatex(input) {
  input = input.replace(/\s+/g, '');
  let fracMatch = input.match(/^(.+?)\/(.+)$/);
  if (fracMatch) {
    return `\\displaystyle\\frac{${fracMatch[1]}}{${fracMatch[2]}}`;
  } else {
    return input.replace(/([a-zA-Z]+)/g, "\\mathit{$1}");
  }
}

function toRepeatingDecimal(num, maxDecimals = 20) {
  let str = num.toString();
  if (!str.includes('.')) return str;
  let frac = num % 1;
  for (let i = 1; i < maxDecimals; i++) {
    let candidate = Math.round(frac * Math.pow(10, i));
    if (candidate === Math.pow(10, i) - 1) {
      let base = Math.floor(num);
      let repDigit = Math.round(frac * Math.pow(10, i)) % 10;
      return `${base === 0 ? '' : base}.\\overline{${repDigit}}`;
    }
  }
  return num.toPrecision(10);
}

function calculate() {
  let prettyInput = document.getElementById('pretty-input-output');
  let stepsDiv = document.getElementById('steps-math-output');
  let input = document.getElementById('input-box').value.trim();

  // Only show the input pretty at the top, not in the steps area
  let inputLatex = input ? `\\(${formatInputAsLatex(input)}\\)` : '';
  prettyInput.innerHTML = inputLatex;

  MathJax.typesetPromise([prettyInput]).then(() => {
    // Measure pretty input width
    let measureSpan = document.createElement('span');
    measureSpan.style.visibility = 'hidden';
    measureSpan.style.position = 'absolute';
    measureSpan.style.left = '-9999px';
    measureSpan.style.fontSize = '1.5em';
    measureSpan.innerHTML = inputLatex;
    document.body.appendChild(measureSpan);

    MathJax.typesetPromise([measureSpan]).then(() => {
      let inputWidth = measureSpan.getBoundingClientRect().width;
      document.body.removeChild(measureSpan);

      let steps = [];

      // Fractions: e.g. 5/9xxx
      let fracMatch = input.replace(/\s+/g,'').match(/^(.+?)\/(.+)$/);
      if (input && fracMatch) {
        let numerator = fracMatch[1], denominator = fracMatch[2];
        let denVars = denominator.match(/([a-zA-Z]+)/g);
        let denNumMatch = denominator.match(/^\d+/);
        let denNum = denNumMatch ? denNumMatch[0] : '1'; // Default to 1 if no leading digits
        let denVarPowers = {};
        if (denVars) {
          denVars.forEach(v => {
            let re = new RegExp(`${v}+`, 'g');
            let count = (denominator.match(re) || ['']).join('').length / v.length;
            denVarPowers[v] = count;
          });
        }
        let denPowLatex = Object.entries(denVarPowers).map(([v, c]) => c > 1 ? `${v}^{${c}}` : v).join('');
        let simpLatex = `\\displaystyle\\frac{${numerator}}{${denNum !== '1' ? denNum : ''}${denPowLatex}}`;

        // Safe parsing:
        let numVal = parseFloat(numerator);
        let denVal = parseFloat(denNum);
        let dec = (!isNaN(numVal) && !isNaN(denVal) && denVal !== 0) ? numVal / denVal : NaN;
        let formattedDec = formatSigFig(dec, currentSigFigs); // <-- Use sig figs!
        let repLatex = (!isNaN(dec)) ? formattedDec : '?';
        let decFracLatex = `\\displaystyle\\frac{${repLatex}}{${denPowLatex}}`;
        let fullDecLatex = `${repLatex}${Object.entries(denVarPowers).length > 0 ? '\\,' : ''}${Object.entries(denVarPowers).map(([v,c])=>`${v}^{-${c}}`).join('')}`;


        // All output rows: indent + = + latex
        [simpLatex, decFracLatex, fullDecLatex].forEach(latex => {
          steps.push(`
            <div class="steps-eq-row">
              <span class="steps-indent" style="width:${inputWidth}px"></span>
              <span class="eq-label">=</span>
              <span class="steps-eq-latex">\\(${latex}\\)</span>
            </div>
          `);
        });

        stepsDiv.innerHTML = steps.join('');
        MathJax.typesetPromise([stepsDiv]);
        return;
      }
      // No steps to show
      stepsDiv.innerHTML = '';
    });
  });
}



// Clipboard button
document.getElementById('copy-latex-btn').onclick = function() {
  let prettyInput = document.getElementById('pretty-input-output');
  if (!prettyInput.textContent) return;
  navigator.clipboard.writeText(prettyInput.textContent)
    .then(() => {
      let btn = document.getElementById('copy-latex-btn');
      btn.textContent = 'âœ…';
      setTimeout(() => btn.textContent = 'ðŸ“‹', 800);
    });
};

// On load
window.onload = function() {
  updatePrettyInput();
  calculate();
  updateUnitOptions(); // <-- Add this line!
};
</script>
</body>
</html>
