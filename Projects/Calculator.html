<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart SI Unit Calculator | Whatmore Industries</title>
  <style>
    body { background: #111; color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 2rem; }
    h2 { text-align: center; }
    #pretty-math-output { font-size: 1.5em; margin-bottom: 0.7em; min-height: 2em; color:#fff;}
    #input-box {
      width: 100%;
      font-size: 1.25rem;
      padding: 0.5rem 1rem;
      background: #181818;
      color: #0f0;
      border: 1px solid #444;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      box-sizing: border-box;
    }
    #result-panel {
      background: #222;
      padding: 1rem;
      border-radius: 0.9rem;
      font-size: 1rem;
      margin-top: 1rem;
      min-height: 60px;
    }
    .section-label { font-weight: bold; color: #0ff; margin-top: 0.5em; }
    .calculator {
      display: grid;
      grid-template-columns: repeat(3, 60px);
      gap: 5px;
    }
    button {
      width: 60px;
      height: 60px;
      font-size: 1.2em;
    }
    .wide { grid-column: span 2; }
    .output-row { margin-bottom: 0.3em; }
    .unit-breakdown { color: #6cf; font-family: 'Consolas', monospace; }
  </style>
  <!-- MATHJAX CDN FOR BEAUTIFUL OUTPUT -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <h2>Smart SI Unit Calculator</h2>
  <div style="display:flex;align-items:center;margin-bottom:0.7em;">
    <div id="pretty-math-output" style="flex:1;"></div>
    <button id="copy-latex-btn" style="margin-left:8px;padding:4px 8px;font-size:1em;cursor:pointer;">üìã</button>
  </div>
  <input id="input-box" 
  placeholder="Enter calculation (e.g. 5 V * 5 A + 5 W)" 
  autocomplete="off"
  oninput="calculate()"
  onkeydown="if(event.key==='Enter'){calculate(); return false;}">


  <div style="margin-bottom:0.5em;">
  Significant figures: 
  <button onclick="setSigFigs(3)">3</button>
  <button onclick="setSigFigs(6)">6</button>
  <button onclick="setSigFigs(10)">10</button>
</div>
  <div class="calculator">
    <button onclick="appendCalc('1')">1</button>
    <button onclick="appendCalc('2')">2</button>
    <button onclick="appendCalc('3')">3</button>
    <button onclick="appendCalc('4')">4</button>
    <button onclick="appendCalc('5')">5</button>
    <button onclick="appendCalc('6')">6</button>
    <button onclick="appendCalc('7')">7</button>
    <button onclick="appendCalc('8')">8</button>
    <button onclick="appendCalc('9')">9</button>
    <button onclick="appendCalc('.')">.</button>
    <button onclick="appendCalc('0')">0</button>
    <button onclick="calculate()">=</button>
    <button class="wide" onclick="backspace()">Backspace</button>
    <button class="wide" onclick="clearCalc()">Clear</button>
  </div>
  <div class="calculator" style="margin-bottom: 8px;">
    <button onclick="appendCalc('x')">x</button>
    <button onclick="appendCalc('y')">y</button>
    <button onclick="appendCalc('z')">z</button>
    <button onclick="appendCalc('a')">a</button>
    <button onclick="appendCalc('b')">b</button>
    <button onclick="appendCalc('c')">c</button>
    <button onclick="appendCalc('^')">^</button>
  </div>
  <div style="margin:1rem 0;">
    <button onclick="appendCalc(' + ')">+</button>
    <button onclick="appendCalc(' - ')">-</button>
    <button onclick="appendCalc(' * ')">*</button>
    <button onclick="appendCalc(' / ')">/</button>
  </div>
  <div>
    <strong>Length</strong><br>
    <button onclick="appendCalc(' nm ')">nm</button>
    <button onclick="appendCalc(' Œºm ')">Œºm</button>
    <button onclick="appendCalc(' mm ')">mm</button>
    <button onclick="appendCalc(' cm ')">cm</button>
    <button onclick="appendCalc(' m ')">m</button>
    <button onclick="appendCalc(' km ')">km</button>
    <button onclick="appendCalc(' in ')">in</button>
    <button onclick="appendCalc(' ft ')">ft</button>
    <button onclick="appendCalc(' yd ')">yd</button>
    <button onclick="appendCalc(' mi ')">mi</button>
  </div>
  <div>
    <strong>Mass</strong><br>
    <button onclick="appendCalc(' mg ')">mg</button>
    <button onclick="appendCalc(' g ')">g</button>
    <button onclick="appendCalc(' kg ')">kg</button>
    <button onclick="appendCalc(' t ')">t</button>
    <button onclick="appendCalc(' oz ')">oz</button>
    <button onclick="appendCalc(' lb ')">lb</button>
    <button onclick="appendCalc(' st ')">st</button>
  </div>
  <div>
    <strong>Time</strong><br>
    <button onclick="appendCalc(' ns ')">ns</button>
    <button onclick="appendCalc(' Œºs ')">Œºs</button>
    <button onclick="appendCalc(' ms ')">ms</button>
    <button onclick="appendCalc(' s ')">s</button>
    <button onclick="appendCalc(' min ')">min</button>
    <button onclick="appendCalc(' hr ')">hr</button>
    <button onclick="appendCalc(' day ')">day</button>
  </div>
  <div>
    <strong>Electricity</strong><br>
    <button onclick="appendCalc(' A ')">A</button>
    <button onclick="appendCalc(' V ')">V</button>
    <button onclick="appendCalc(' W ')">W</button>
    <button onclick="appendCalc(' F ')">F</button>
    <button onclick="appendCalc(' Œ© ')">Œ©</button>
    <button onclick="appendCalc(' C ')">C</button>
  </div>
  <div id="result-panel"></div>

<script>
const BASES = ['kg', 'm', 's', 'A', 'K', 'mol', 'cd'];
const UNIT_TABLE = {
  m:   {kg:0, m:1, s:0, A:0, K:0, mol:0, cd:0},
  kg:  {kg:1, m:0, s:0, A:0, K:0, mol:0, cd:0},
  s:   {kg:0, m:0, s:1, A:0, K:0, mol:0, cd:0},
  A:   {kg:0, m:0, s:0, A:1, K:0, mol:0, cd:0},
  K:   {kg:0, m:0, s:0, A:0, K:1, mol:0, cd:0},
  mol: {kg:0, m:0, s:0, A:0, K:0, mol:1, cd:0},
  cd:  {kg:0, m:0, s:0, A:0, K:0, mol:0, cd:1},
  N:   {kg:1, m:1, s:-2, A:0, K:0, mol:0, cd:0},
  J:   {kg:1, m:2, s:-2, A:0, K:0, mol:0, cd:0},
  W:   {kg:1, m:2, s:-3, A:0, K:0, mol:0, cd:0},
  V:   {kg:1, m:2, s:-3, A:-1, K:0, mol:0, cd:0},
  C:   {kg:0, m:0, s:1, A:1, K:0, mol:0, cd:0},
  Œ©:   {kg:1, m:2, s:-3, A:-2, K:0, mol:0, cd:0},
  F:   {kg:-1, m:-2, s:4, A:2, K:0, mol:0, cd:0},
  S:   {kg:-1, m:-2, s:3, A:2, K:0, mol:0, cd:0},
  H:   {kg:1, m:2, s:-2, A:-2, K:0, mol:0, cd:0},
  VA:  {kg:1, m:2, s:-3, A:0, K:0, mol:0, cd:0},
};
const DERIVED_LOOKUP = Object.fromEntries(
  Object.entries(UNIT_TABLE).map(([k,v])=>[JSON.stringify(v),k])
);
const UNITS = {
  nm:  [1e-9, 'm'], Œºm:[1e-6,'m'], mm:[1e-3,'m'], cm:[1e-2,'m'], m:[1,'m'], km:[1e3,'m'],
  in: [0.0254,'m'], ft:[0.3048,'m'], yd:[0.9144,'m'], mi:[1609.34,'m'],
  mg:[1e-6,'kg'], g:[1e-3,'kg'], kg:[1,'kg'], t:[1000,'kg'],
  oz:[0.0283495,'kg'], lb:[0.453592,'kg'], st:[6.35029,'kg'],
  ns:[1e-9,'s'], Œºs:[1e-6,'s'], ms:[1e-3,'s'], s:[1,'s'], min:[60,'s'], hr:[3600,'s'], day:[86400,'s'],
  A:[1,'A'], V:[1,'V'], W:[1,'W'], F:[1,'F'], Œ©:[1,'Œ©'], C:[1,'C'],
  N:[1,'N'], J:[1,'J'], S:[1,'S'], H:[1,'H'],
  VA:[1,'VA'],
};
  let currentSigFigs = 10;
function setSigFigs(n) {
  currentSigFigs = n;
  calculate(); // update output
}

function cloneExp(e) { return Object.assign({}, e); }
function zeroExp() { let o={}; BASES.forEach(b=>o[b]=0); return o; }
function addExp(e1, e2, sign=1) {
  let out = {};
  BASES.forEach(b => out[b] = (e1[b]||0) + sign*(e2[b]||0));
  return out;
}
function expToStr(exp) {
  return Object.entries(exp)
    .filter(([k, v]) => v !== 0)
    .map(([k, v]) => {
      if (v === 1) return k;
      if (v === -1) return k + '‚Åª¬π';
      return `${k}^${v}`;
    })
    .join('¬∑') || '';
}
function expToDerived(exp) {
  let key = JSON.stringify(exp);
  return DERIVED_LOOKUP[key] || null;
}
function decimalToFraction(value, maxDenom=10000) {
  if (!isFinite(value)) return value.toString();
  let num = value, denom = 1, bestNum = 1, bestDenom = 1, bestError = Math.abs(value-1);
  for (let d=1; d<=maxDenom; d++) {
    let n = Math.round(value*d);
    let error = Math.abs(value - n/d);
    if (error < bestError) {
      bestNum = n; bestDenom = d; bestError = error;
    }
    if (bestError < 1e-8) break;
  }
  return (bestDenom === 1) ? bestNum.toString() : `${bestNum}/${bestDenom}`;
}
function appendCalc(val) {
  const box = document.getElementById('input-box');
  if (!box) return;
  const start = box.selectionStart;
  const end = box.selectionEnd;
  const text = box.value;
  box.value = text.slice(0, start) + val + text.slice(end);
  const caretPos = start + val.length;
  box.setSelectionRange(caretPos, caretPos);
  box.focus();
  calculate(); // <<< Add this!
}

function clearCalc() {
  document.getElementById('input-box').value = '';
  document.getElementById('result-panel').innerHTML = '';
  document.getElementById('pretty-math-output').innerHTML = '';
  calculate(); // <<< Add this!
}

function backspace() {
  const box = document.getElementById('input-box');
  const start = box.selectionStart;
  const end = box.selectionEnd;
  if (start === end && start > 0) {
    box.value = box.value.slice(0, start-1) + box.value.slice(end);
    box.setSelectionRange(start-1, start-1);
  } else {
    box.value = box.value.slice(0, start) + box.value.slice(end);
    box.setSelectionRange(start, start);
  }
  box.focus();
  calculate(); // <<< Add this!
}

// ----------- MATHJAX FORMATTING -----------
// Cursive/italic for variables: SI units get upright, all other variables get math italics
function expToLatex(exp) {
  let unitParts = [];
  for (const [k, v] of Object.entries(exp)) {
    if (!v) continue;
    if (BASES.includes(k)) {
      unitParts.push(`\\mathrm{${k}}` + (v === 1 ? '' : `^{${v}}`));
    } else {
      unitParts.push(`\\mathit{${k}}` + (v === 1 ? '' : `^{${v}}`));
    }
  }
  return unitParts.join('\\,');
}
function termToLatex(val, exp, fractionMode = false, sigFigs = currentSigFigs, useRepeating = true) {
  let numStr;
  if (fractionMode) {
    numStr = decimalToFraction(val);
  } else if (useRepeating && (val === 1/9 || val === 2/9 || val === 1/3)) {
    numStr = toRepeatingDecimal(val);
  } else {
    numStr = (+val).toPrecision(sigFigs);
  }
  let parts = [];
  if (numStr.includes('/')) {
    const [num, den] = numStr.split('/');
    parts.push(`\\frac{${num}}{${den}}`);
  } else {
    parts.push(numStr);
  }
  let unitLatex = expToLatex(exp);
  if (unitLatex) parts.push(unitLatex);
  return parts.join('\\, ');
}
function resultsToLatex(resultMap, fractionMode=false, sigFigs=currentSigFigs) {
  let rows = [];
  for (let expKey in resultMap) {
    let v = resultMap[expKey];
    if (!v) continue;
    let exp = JSON.parse(expKey);
    rows.push(termToLatex(v, exp, fractionMode, sigFigs));
  }
  return rows.join(' + ');
}

let lastLatex = "";
function calculate() {
  let panel = document.getElementById('result-panel');
  let prettyDiv = document.getElementById('pretty-math-output');
  panel.innerHTML = '';
  prettyDiv.innerHTML = '';
  let input = document.getElementById('input-box').value.trim();
  // Split terms on + or -, keeping sign
  let termRegex = /([+\-]?[^+\-]+)/g;
  let terms = [];
  let match;
  while ((match = termRegex.exec(input)) !== null) {
    let seg = match[0].trim();
    if (seg) terms.push(seg);
  }
  if (!terms.length) {
    panel.innerHTML = `<span style='color:red;'>Could not parse input.<br>Try: 5 V * 5 A + 5 W</span>`;
    prettyDiv.innerHTML = '';
    MathJax.typesetPromise();
    return;
  }
  function parseFactor(str) {
    let m = str.match(/^([+\-]?\d*\.?\d+)?\s*([a-zA-ZŒºŒ©]+)?(?:\^([+\-]?\d+))?$/);
    let val = m && m[1] ? parseFloat(m[1]) : 1;
    let unit = m && m[2] ? m[2] : '';
    let pow = m && m[3] ? parseInt(m[3]) : 1;
    if (!unit) return [val, zeroExp()];
    if (UNITS[unit]) {
      let [f, baseUnit] = UNITS[unit];
      val *= f ** pow;
      let baseExp = UNIT_TABLE[baseUnit] || zeroExp();
      let resultExp = {};
      BASES.forEach(b => resultExp[b] = (baseExp[b]||0)*pow);
      return [val, resultExp];
    }
    if (UNIT_TABLE[unit]) {
      let baseExp = UNIT_TABLE[unit];
      let resultExp = {};
      BASES.forEach(b => resultExp[b] = (baseExp[b]||0)*pow);
      return [val, resultExp];
    }
    let symbolicExp = zeroExp();
    symbolicExp[unit] = pow;
    return [val, symbolicExp];
  }
  function evalTerm(term) {
    let multParts = term.split(/([*/])/);
    let val = null, exp = zeroExp(), lastOp = '*';
    for (let i=0; i<multParts.length; i++) {
      let part = multParts[i].trim();
      if (part === '*' || part === '/') {
        lastOp = part;
      } else if (part.length) {
        let [v, e] = parseFactor(part);
        if (val === null) {
          val = v;
          exp = cloneExp(e);
        } else {
          if (lastOp === '*') {
            val *= v;
            exp = addExp(exp, e, 1);
          } else {
            val /= v;
            exp = addExp(exp, e, -1);
          }
        }
      }
    }
    return [val, exp];
  }

  function toRepeatingDecimal(num, maxDecimals = 20) {
  // Only support for repeating NINES for now, e.g., 1/9, 2/9, 1/3
  let str = num.toString();
  if (!str.includes('.')) return str;

  let frac = num % 1;
  for (let i = 1; i < maxDecimals; i++) {
    let repeated = Number('0.' + '9'.repeat(i));
    let candidate = Math.round(frac * Math.pow(10, i));
    if (candidate === Math.pow(10, i) - 1) {
      // It's a repeating nines decimal!
      let base = Math.floor(num);
      let decimal = Math.floor(frac * Math.pow(10, i - 1));
let repDigit = Math.round(frac * Math.pow(10, i)) % 10;
return `${base === 0 ? '' : base}.\\overline{${repDigit}}`;
  }
  return num.toPrecision(10); // fallback
}

  // Map of stringified exponents to summed values
  let resultMap = {};
  for (let seg of terms) {
    let sign = 1;
    if (seg.startsWith('-')) { sign = -1; seg = seg.slice(1).trim(); }
    if (seg.startsWith('+')) { seg = seg.slice(1).trim(); }
    let [v, exp] = evalTerm(seg);
    let expKey = JSON.stringify(exp);
    if (!resultMap[expKey]) resultMap[expKey] = 0;
    resultMap[expKey] += sign * v;
  }
  // --- Pretty Math Output ---
  let latex = resultsToLatex(resultMap, false);
  lastLatex = latex; // store for copy
  if (latex.trim()) {
    prettyDiv.innerHTML = `\\(${latex}\\)`;
  } else {
    prettyDiv.innerHTML = '';
  }
  MathJax.typesetPromise();
  // --- Standard Output ---
  let outRows = [], fracRows = [];
  for (let expKey in resultMap) {
    let v = resultMap[expKey];
    if (!v) continue;
    let exp = JSON.parse(expKey);
    let derived = expToDerived(exp);
    let baseStr = expToStr(exp);
    let valueStr = v.toString();
    let fracStr = decimalToFraction(v);
    let main = derived
      ? `${valueStr} ${derived}`
      : (baseStr ? `${valueStr} ${baseStr}` : valueStr);
    let base = (baseStr && (!derived || baseStr !== derived))
      ? `${valueStr} ${baseStr}`
      : '';
    let out = (base && base !== main)
      ? main + ` <span class='unit-breakdown'>(${base})</span>`
      : main;
    outRows.push(out);
    fracRows.push(
      derived
        ? `${fracStr} ${derived}`
        : (baseStr ? `${fracStr} ${baseStr}` : fracStr)
    );
  }
  if (!outRows.length) {
    panel.innerHTML = `<span style='color:red;'>No nonzero result.</span>`;
    return;
  }
  panel.innerHTML = `
    <div class='output-row'><span class='section-label'>Decimal:</span> ${outRows.join(' + ')}</div>
    <div class='output-row'><span class='section-label'>Fraction:</span> ${fracRows.join(' + ')}</div>
  `;
}
// -- Clipboard button handler (needs to be outside calculate so it's only attached once) --
document.getElementById('copy-latex-btn').onclick = function() {
  if (!lastLatex) return;
  navigator.clipboard.writeText(String.raw`\\(${lastLatex}\\)`)
    .then(() => {
      let btn = document.getElementById('copy-latex-btn');
      btn.textContent = '‚úÖ';
      setTimeout(() => btn.textContent = 'üìã', 800);
    });
};
</script>
</body>
</html>
